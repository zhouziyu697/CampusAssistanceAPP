<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å•†å“ - æ ¡å›­äº’åŠ©å¹³å°</title>
    <link rel="stylesheet" href="../src/assets/css/style.css">
    <link rel="stylesheet" href="../src/assets/css/button-fix.css">
    <style>
        /* æˆ‘çš„å•†å“é¡µé¢æ ·å¼ */
        .my-products-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
 
        .back-btn {
            padding: 8px 15px;
            background-color: #f1f1f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s;
        }

        .back-btn:hover {
            background-color: #e4e4e4;
        }

        .back-btn span {
            font-size: 18px;
            line-height: 1;
        }

        .my-products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            margin: 0;
            font-size: 24px;
        }

        .publish-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tab-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 5px;
            cursor: pointer;
            position: relative;
            color: #666;
        }

        .tab.active {
            color: #3498db;
            font-weight: bold;
        }

        .tab.active:after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .product-image-container {
            height: 200px;
            overflow: hidden;
            position: relative;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: white;
            background-color: #2ecc71;
        }

        .product-status.sold {
            background-color: #e74c3c;
        }

        .product-status.pending {
            background-color: #f39c12;
        }

        .product-status.draft {
            background-color: #7f8c8d;
        }

        .product-info {
            padding: 15px;
        }

        .product-title {
            margin: 0 0 10px 0;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .product-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 18px;
        }

        .product-date {
            color: #7f8c8d;
            font-size: 12px;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 8px 0;
            text-align: center;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .action-btn:active {
            transform: translateY(0);
        }

        .edit-btn {
            background-color: #3498db;
            color: white;
        }
        
        .edit-btn:hover {
            background-color: #2980b9;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }

        .sold-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .sold-btn:hover {
            background-color: #27ae60;
        }

        .republish-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .republish-btn:hover {
            background-color: #e67e22;
        }

        .views-info {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #7f8c8d;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            margin-bottom: 20px;
        }

        .empty-action-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* åŠ è½½ä¸­æ ·å¼ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            margin-top: 0;
            color: #333;
        }

        .modal-message {
            color: #666;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-cancel {
            background-color: #f1f1f1;
            color: #333;
        }

        .modal-confirm {
            background-color: #e74c3c;
            color: white;
        }
        
        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease-out forwards;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .message.info {
            background-color: #3498db;
        }
        
        .message.success {
            background-color: #2ecc71;
        }
        
        .message.warning {
            background-color: #f39c12;
        }
        
        .message.error {
            background-color: #e74c3c;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .product-list {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .my-products-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            .product-list {
                grid-template-columns: 1fr;
            }
            
            .tab-group {
                overflow-x: auto;
                white-space: nowrap;
                width: 100%;
                padding-bottom: 10px;
            }
            
            .tab {
                display: inline-block;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="nav-brand">æ ¡å›­äº’åŠ©å¹³å°</div>
            <div class="nav-links">
                <a href="index.html">é¦–é¡µ</a>
                <a href="market.html">äºŒæ‰‹å¸‚åœº</a>
                <a href="express.html">å¿«é€’ä»£é¢†</a>
                <a href="profile.html" class="active">ä¸ªäººä¸­å¿ƒ</a>
            </div>
        </nav>

        <!-- æˆ‘çš„å•†å“å†…å®¹ -->
        <div class="my-products-container">
            <div class="my-products-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="back-btn" id="backBtn" onclick="window.location.href='profile.html'">
                        <span>â†</span> è¿”å›
                    </button>
                    <h1 class="header-title">æˆ‘çš„å•†å“</h1>
                </div>
                <div>
                    <button class="publish-btn" id="publishBtn">+ å‘å¸ƒå•†å“</button>
                    <button class="publish-btn" id="wantedPublishBtn" style="background-color: #f39c12;">+ å‘å¸ƒæ±‚è´­</button>
                </div>
            </div>

            <div class="tab-group">
                <div class="tab active" data-tab="all">å…¨éƒ¨å•†å“</div>
                <div class="tab" data-tab="selling">åœ¨å”®å•†å“</div>
                <div class="tab" data-tab="sold">å·²å”®å•†å“</div>
                <div class="tab" data-tab="wanted">æˆ‘çš„æ±‚è´­</div>
                <div class="tab" data-tab="draft">è‰ç¨¿ç®±</div>
            </div>

            <div id="allTab" class="tab-content active">
                <div class="loading" id="allLoading">
                    <div class="spinner"></div>
                </div>
                <div class="product-list" id="allProductList"></div>
                <div class="empty-state" id="allEmptyState" style="display: none;">
                    <div class="empty-state-icon">ğŸ“¦</div>
                    <div class="empty-state-text">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒè¿‡å•†å“</div>
                    <button class="empty-action-btn" id="emptyPublishBtn">ç«‹å³å‘å¸ƒ</button>
                </div>
            </div>

            <div id="sellingTab" class="tab-content">
                <div class="loading" id="sellingLoading">
                    <div class="spinner"></div>
                </div>
                <div class="product-list" id="sellingProductList"></div>
                <div class="empty-state" id="sellingEmptyState" style="display: none;">
                    <div class="empty-state-icon">ğŸ·ï¸</div>
                    <div class="empty-state-text">æš‚æ— æ­£åœ¨å‡ºå”®çš„å•†å“</div>
                    <button class="empty-action-btn" id="sellingPublishBtn">ç«‹å³å‘å¸ƒ</button>
                </div>
            </div>

            <div id="soldTab" class="tab-content">
                <div class="loading" id="soldLoading">
                    <div class="spinner"></div>
                </div>
                <div class="product-list" id="soldProductList"></div>
                <div class="empty-state" id="soldEmptyState" style="display: none;">
                    <div class="empty-state-icon">ğŸ’°</div>
                    <div class="empty-state-text">æš‚æ— å·²å”®å‡ºçš„å•†å“</div>
                </div>
            </div>
            
            <div id="wantedTab" class="tab-content">
                <div class="loading" id="wantedLoading">
                    <div class="spinner"></div>
                </div>
                <div class="product-list" id="wantedProductList"></div>
                <div class="empty-state" id="wantedEmptyState" style="display: none;">
                    <div class="empty-state-icon">ğŸ”</div>
                    <div class="empty-state-text">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒè¿‡æ±‚è´­ä¿¡æ¯</div>
                    <button class="empty-action-btn" id="wantedEmptyPublishBtn">ç«‹å³å‘å¸ƒæ±‚è´­</button>
                </div>
            </div>

            <div id="draftTab" class="tab-content">
                <div class="loading" id="draftLoading">
                    <div class="spinner"></div>
                </div>
                <div class="product-list" id="draftProductList"></div>
                <div class="empty-state" id="draftEmptyState" style="display: none;">
                    <div class="empty-state-icon">ğŸ“</div>
                    <div class="empty-state-text">æš‚æ— è‰ç¨¿</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3 class="modal-title">ç¡®è®¤åˆ é™¤</h3>
            <p class="modal-message">æ‚¨ç¡®å®šè¦åˆ é™¤æ­¤å•†å“å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            <div class="modal-actions">
                <button class="modal-btn modal-cancel" id="cancelDeleteBtn">å–æ¶ˆ</button>
                <button class="modal-btn modal-confirm" id="confirmDeleteBtn">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="message"></div>

    <script>
        // è®¾ç½®æœåŠ¡å™¨åœ°å€
        const serverAddress = 'http://localhost:8080';
        
        // æ—¥æœŸæ ¼å¼åŒ–
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit' 
            });
        }
        
        // å¤„ç†å›¾ç‰‡URL
        function getImageUrl(images) {
            if (!images || images.length === 0 || !images[0]) {
                return '../src/assets/images/placeholder.jpg';
            }
            
            let imageUrl = images[0];
            // å¦‚æœæ˜¯ä¸Šä¼ è·¯å¾„ï¼Œéœ€è¦æ·»åŠ æœåŠ¡å™¨å‰ç¼€
            if (imageUrl.startsWith('/uploads/')) {
                return serverAddress + imageUrl;
            }
            
            return imageUrl;
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info', duration = 3000) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, duration);
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('è¯·å…ˆç™»å½•', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return false;
            }
            return true;
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            
            // åŠ è½½å•†å“æ•°æ®
            loadProducts('all');
            
            // æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // åˆ‡æ¢æ¿€æ´»çš„æ ‡ç­¾
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // åˆ‡æ¢æ˜¾ç¤ºçš„å†…å®¹
                    const tabName = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabName}Tab`).classList.add('active');
                    
                    // åŠ è½½å¯¹åº”æ ‡ç­¾çš„æ•°æ®
                    loadProducts(tabName);
                });
            });
            
            // å‘å¸ƒæ–°å•†å“æŒ‰é’®äº‹ä»¶
            document.getElementById('publishBtn').addEventListener('click', function() {
                window.location.href = 'publish-product.html';
            });
            
            // å‘å¸ƒæ±‚è´­æŒ‰é’®äº‹ä»¶
            document.getElementById('wantedPublishBtn').addEventListener('click', function() {
                window.location.href = 'wanted-product.html';
            });
            
            // ç©ºçŠ¶æ€å‘å¸ƒæŒ‰é’®äº‹ä»¶
            document.getElementById('emptyPublishBtn').addEventListener('click', function() {
                window.location.href = 'publish-product.html';
            });
            
            document.getElementById('sellingPublishBtn').addEventListener('click', function() {
                window.location.href = 'publish-product.html';
            });
            
            document.getElementById('wantedEmptyPublishBtn').addEventListener('click', function() {
                window.location.href = 'wanted-product.html';
            });
            
            // ç¡®è®¤å¯¹è¯æ¡†äº‹ä»¶
            document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
                document.getElementById('confirmModal').style.display = 'none';
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                const productType = this.getAttribute('data-product-type');
                deleteProduct(productId, productType);
            });
        });

        // åŠ è½½å•†å“æ•°æ®
        async function loadProducts(tabName) {
            // æ˜¾ç¤ºåŠ è½½ä¸­
            document.getElementById(`${tabName}Loading`).style.display = 'flex';
            document.getElementById(`${tabName}ProductList`).innerHTML = '';
            document.getElementById(`${tabName}EmptyState`).style.display = 'none';
            
            try {
                const token = localStorage.getItem('token');
                let url;
                
                // æ ¹æ®ä¸åŒçš„æ ‡ç­¾é¡µé€‰æ‹©ä¸åŒçš„API
                if (tabName === 'draft') {
                    url = serverAddress + '/api/profile/drafts';
                } else if (tabName === 'wanted') {
                    url = serverAddress + '/api/profile/wanted-items';
                } else if (tabName === 'all') {
                    url = serverAddress + '/api/products/user';
                } else {
                    const statusMap = {
                        'selling': 'ACTIVE',
                        'sold': 'SOLD'
                    };
                    url = serverAddress + `/api/products/user?status=${statusMap[tabName] || ''}`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å•†å“åˆ—è¡¨å¤±è´¥');
                }
                
                const products = await response.json();
                
                // éšè—åŠ è½½ä¸­
                document.getElementById(`${tabName}Loading`).style.display = 'none';
                
                if (!products || products.length === 0) {
                    document.getElementById(`${tabName}EmptyState`).style.display = 'block';
                    return;
                }
                
                // æ¸²æŸ“å•†å“åˆ—è¡¨
                const productListEl = document.getElementById(`${tabName}ProductList`);
                productListEl.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹
                
                // æ¸²æŸ“å•†å“åˆ—è¡¨
                if (tabName === 'draft') {
                    // å¤„ç†è‰ç¨¿æ•°æ®
                    products.forEach(draft => {
                        try {
                            // è§£æè‰ç¨¿å†…å®¹
                            const draftContent = JSON.parse(draft.content);
                            const productCard = createProductCard({
                                id: draft.id,
                                title: draft.title || draftContent.title || 'æ— æ ‡é¢˜è‰ç¨¿',
                                price: draftContent.price || 0,
                                description: draftContent.description || '',
                                images: draftContent.images || [],
                                status: 'DRAFT',
                                publishTime: draft.updatedAt || draft.createdAt,
                                lastModified: draft.updatedAt || draft.createdAt
                            }, tabName);
                            productListEl.appendChild(productCard);
                        } catch (error) {
                            console.error('è§£æè‰ç¨¿å†…å®¹å¤±è´¥:', error);
                            // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸºæœ¬ä¿¡æ¯åˆ›å»ºå¡ç‰‡
                            const productCard = createProductCard({
                                id: draft.id,
                                title: draft.title || 'æ— æ ‡é¢˜è‰ç¨¿',
                                price: 0,
                                description: '',
                                images: [],
                                status: 'DRAFT',
                                publishTime: draft.updatedAt || draft.createdAt,
                                lastModified: draft.updatedAt || draft.createdAt
                            }, tabName);
                            productListEl.appendChild(productCard);
                        }
                    });
                } else if (tabName === 'wanted') {
                    // å¤„ç†æ±‚è´­æ•°æ®
                    products.forEach(item => {
                        const productCard = createProductCard({
                            id: item.id,
                            title: item.title,
                            price: item.maxBudget || 0,
                            minPrice: item.minPrice || 0,
                            maxPrice: item.maxBudget || 0,
                            description: item.description || '',
                            status: item.status || 'ACTIVE',
                            publishTime: item.createdAt,
                            lastModified: item.updatedAt,
                            type: 'WANTED'
                        }, tabName);
                        productListEl.appendChild(productCard);
                    });
                } else {
                    // å¤„ç†æ™®é€šå•†å“æ•°æ®
                    products.forEach(product => {
                        const productCard = createProductCard(product, tabName);
                        productListEl.appendChild(productCard);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å•†å“å¤±è´¥:', error);
                showMessage(error.message || 'åŠ è½½å•†å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                document.getElementById(`${tabName}Loading`).style.display = 'none';
                document.getElementById(`${tabName}EmptyState`).style.display = 'block';
            }
        }

        // åˆ›å»ºå•†å“å¡ç‰‡
        function createProductCard(product, tabName) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºæ±‚è´­å•†å“
            const isWanted = product.type === 'WANTED' || tabName === 'wanted';
            
            // å•†å“çŠ¶æ€æ˜ å°„
            const statusTextMap = {
                'ACTIVE': isWanted ? 'æ±‚è´­ä¸­' : 'åœ¨å”®ä¸­',
                'SOLD': isWanted ? 'å·²è§£å†³' : 'å·²å”®å‡º',
                'PENDING': 'å¾…å®¡æ ¸',
                'DRAFT': 'è‰ç¨¿'
            };
            
            const statusClassMap = {
                'ACTIVE': '',
                'SOLD': 'sold',
                'PENDING': 'pending',
                'DRAFT': 'draft'
            };
            
            if (isWanted) {
                // æ±‚è´­å•†å“å¡ç‰‡
                const urgencyClassMap = {
                    'very_urgent': 'sold',
                    'urgent': 'pending',
                    'normal': ''
                };
                
                const urgencyTextMap = {
                    'very_urgent': 'éå¸¸æ€¥éœ€',
                    'urgent': 'æ€¥éœ€',
                    'normal': 'æ™®é€š'
                };
                
                const urgencyClass = urgencyClassMap[product.urgencyLevel] || '';
                const urgencyText = urgencyTextMap[product.urgencyLevel] || 'æ™®é€š';
                const priceRange = `${formatPrice(product.minPrice)} - ${formatPrice(product.maxPrice)}`;
                
                card.innerHTML = `
                    <div class="product-image-container">
                        <div class="product-status ${statusClassMap[product.status] || ''}">${statusTextMap[product.status] || 'æœªçŸ¥'}</div>
                        <div class="product-status ${urgencyClass}" style="left: 10px; right: auto;">${urgencyText}</div>
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">æ±‚è´­: ${product.title}</h3>
                        <div class="product-meta">
                            <span class="product-price">${priceRange}</span>
                            <span class="views-info">ğŸ‘ï¸ ${product.viewCount || 0}</span>
                        </div>
                        <div class="product-date">å‘å¸ƒäº ${formatDate(product.publishTime || product.lastModified)}</div>
                        <div class="product-actions">
                            ${renderActions(product, tabName)}
                        </div>
                    </div>
                `;
            } else {
                // æ™®é€šå•†å“å¡ç‰‡
                card.innerHTML = `
                    <div class="product-image-container">
                        <img src="${getImageUrl(product.images)}" alt="${product.title}" class="product-image">
                        <div class="product-status ${statusClassMap[product.status] || ''}">${statusTextMap[product.status] || 'æœªçŸ¥'}</div>
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${product.title}</h3>
                        <div class="product-meta">
                            <span class="product-price">Â¥${parseFloat(product.price).toFixed(2)}</span>
                            <span class="views-info">ğŸ‘ï¸ ${product.viewCount || 0}</span>
                        </div>
                        <div class="product-date">å‘å¸ƒäº ${formatDate(product.publishTime || product.lastModified)}</div>
                        <div class="product-actions">
                            ${renderActions(product, tabName)}
                        </div>
                    </div>
                `;
            }
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            setTimeout(() => {
                const editBtn = card.querySelector('.edit-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        editProduct(product.id, product.type);
                    });
                }
                
                const deleteBtn = card.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        showDeleteConfirm(product.id, product.type);
                    });
                }
                
                const soldBtn = card.querySelector('.sold-btn');
                if (soldBtn) {
                    soldBtn.addEventListener('click', function() {
                        markAsSold(product.id, product.type);
                    });
                }
                
                const republishBtn = card.querySelector('.republish-btn');
                if (republishBtn) {
                    republishBtn.addEventListener('click', function() {
                        republishProduct(product.id, product.type);
                    });
                }
            }, 0);
            
            return card;
        }

        // æ¸²æŸ“å•†å“æ“ä½œæŒ‰é’®
        function renderActions(product, tabName) {
            const isWanted = product.type === 'WANTED' || tabName === 'wanted';
            const editUrl = isWanted ? 'wanted-product.html' : 'publish-product.html';
            const soldText = isWanted ? 'æ ‡è®°è§£å†³' : 'æ ‡è®°å”®å‡º';
            
            if (product.status === 'DRAFT') {
                return `
                    <button class="action-btn edit-btn" data-id="${product.id}" title="ç¼–è¾‘è‰ç¨¿">ç¼–è¾‘</button>
                    <button class="action-btn delete-btn" data-id="${product.id}" title="åˆ é™¤è‰ç¨¿">åˆ é™¤</button>
                `;
            } else if (product.status === 'ACTIVE') {
                return `
                    <button class="action-btn edit-btn" data-id="${product.id}" title="ç¼–è¾‘å•†å“ä¿¡æ¯">ç¼–è¾‘</button>
                    <button class="action-btn sold-btn" data-id="${product.id}" title="å°†å•†å“æ ‡è®°ä¸º${isWanted ? 'å·²è§£å†³' : 'å·²å”®å‡º'}">${soldText}</button>
                    <button class="action-btn delete-btn" data-id="${product.id}" title="åˆ é™¤å•†å“">åˆ é™¤</button>
                `;
            } else if (product.status === 'SOLD') {
                return `
                    <button class="action-btn republish-btn" data-id="${product.id}" title="å°†å•†å“é‡æ–°å‘å¸ƒåˆ°å¸‚åœº">é‡æ–°å‘å¸ƒ</button>
                    <button class="action-btn delete-btn" data-id="${product.id}" title="åˆ é™¤å•†å“">åˆ é™¤</button>
                `;
            } else {
                return `
                    <button class="action-btn delete-btn" data-id="${product.id}" title="åˆ é™¤å•†å“">åˆ é™¤</button>
                `;
            }
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
        function showDeleteConfirm(productId, productType) {
            const modal = document.getElementById('confirmModal');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            confirmBtn.setAttribute('data-product-id', productId);
            confirmBtn.setAttribute('data-product-type', productType || 'NORMAL');
            modal.style.display = 'flex';
        }

        // åˆ é™¤å•†å“
        async function deleteProduct(productId, productType) {
            try {
                const token = localStorage.getItem('token');
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const productType = confirmBtn.getAttribute('data-product-type');
                
                // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
                showMessage('æ­£åœ¨åˆ é™¤...', 'info');
                
                // åˆ¤æ–­åˆ é™¤çš„æ˜¯æ™®é€šå•†å“è¿˜æ˜¯æ±‚è´­å•†å“
                const url = productType === 'WANTED' ? 
                    serverAddress + `/api/products/wanted/${productId}` : 
                    serverAddress + `/api/products/${productId}`;
                
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                // éšè—ç¡®è®¤å¯¹è¯æ¡†
                document.getElementById('confirmModal').style.display = 'none';
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showMessage('å•†å“å·²æˆåŠŸåˆ é™¤', 'success');
                
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾çš„æ•°æ®
                const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
                loadProducts(activeTab);
            } catch (error) {
                console.error('åˆ é™¤å•†å“å¤±è´¥:', error);
                showMessage(error.message || 'åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                document.getElementById('confirmModal').style.display = 'none';
            }
        }

        // ç¼–è¾‘å•†å“
        function editProduct(productId, productType) {
            showMessage('æ­£åœ¨å‡†å¤‡ç¼–è¾‘é¡µé¢...', 'info');
            if (productType === 'WANTED') {
                window.location.href = `wanted-product.html?id=${productId}`;
            } else {
                window.location.href = `publish-product.html?id=${productId}`;
            }
        }

        // æ ‡è®°ä¸ºå·²å”®å‡º/å·²è§£å†³
        async function markAsSold(productId, productType) {
            try {
                const token = localStorage.getItem('token');
                
                // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
                const message = productType === 'WANTED' ? 'æ­£åœ¨æ ‡è®°ä¸ºå·²è§£å†³...' : 'æ­£åœ¨æ ‡è®°ä¸ºå·²å”®å‡º...';
                showMessage(message, 'info');
                
                const url = productType === 'WANTED' ? 
                    serverAddress + `/api/products/wanted/${productId}/status` : 
                    serverAddress + `/api/products/${productId}/status`;
                
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: 'SOLD' })
                });
                
                if (!response.ok) {
                    throw new Error('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const successMessage = productType === 'WANTED' ? 'å·²æ ‡è®°ä¸ºå·²è§£å†³' : 'å·²æ ‡è®°ä¸ºå”®å‡º';
                showMessage(successMessage, 'success');
                
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾çš„æ•°æ®
                const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
                loadProducts(activeTab);
            } catch (error) {
                console.error('æ ‡è®°å¤±è´¥:', error);
                showMessage(error.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // é‡æ–°å‘å¸ƒå•†å“
        async function republishProduct(productId, productType) {
            try {
                const token = localStorage.getItem('token');
                
                // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
                showMessage('æ­£åœ¨é‡æ–°å‘å¸ƒ...', 'info');
                
                const url = productType === 'WANTED' ? 
                    serverAddress + `/api/products/wanted/${productId}/status` : 
                    serverAddress + `/api/products/${productId}/status`;
                
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: 'ACTIVE' })
                });
                
                if (!response.ok) {
                    throw new Error('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showMessage('å·²é‡æ–°å‘å¸ƒ', 'success');
                
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾çš„æ•°æ®
                const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
                loadProducts(activeTab);
            } catch (error) {
                console.error('é‡æ–°å‘å¸ƒå¤±è´¥:', error);
                showMessage(error.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // æ ¼å¼åŒ–ä»·æ ¼
        function formatPrice(price) {
            if (!price) return 'é¢è®®';
            return 'Â¥' + parseFloat(price).toFixed(2);
        }
    </script>
</body>
</html> 
