<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è¯¦æƒ… - æ ¡å›­äº’åŠ©å¹³å°</title>
    <link rel="stylesheet" href="../src/assets/css/style.css">
    <link rel="stylesheet" href="../src/assets/css/button-fix.css">
    <style>
        /* å•†å“è¯¦æƒ…é¡µæ ·å¼*/
        .detail-container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .back-btn {
            padding: 8px 15px;
            background-color: #f1f1f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .product-content {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }

        .product-images {
            flex: 0 0 50%;
        }

        .main-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .product-info {
            flex: 1;
        }

        .product-title {
            font-size: 24px;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 28px;
            color: #e74c3c;
            font-weight: bold;
            margin: 10px 0;
        }

        .original-price {
            font-size: 18px;
            color: #777;
            text-decoration: line-through;
            margin-left: 10px;
        }

        .product-meta {
            margin: 20px 0;
        }

        .meta-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .meta-label {
            font-weight: bold;
            min-width: 80px;
        }

        .product-description {
            margin-top: 20px;
            line-height: 1.6;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        .buy-btn {
            background-color: #e74c3c;
            color: white;
        }

        .contact-btn {
            background-color: #3498db;
            color: white;
        }

        .favorite-btn {
            background-color: #f1f1f1;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .favorite-btn.active {
            background-color: #f39c12;
            color: white;
        }

        .seller-info {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .seller-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .seller-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .seller-name {
            font-weight: bold;
            font-size: 18px;
        }

        .related-products {
            margin-top: 40px;
        }

        .related-title {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .related-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .related-card:hover {
            transform: translateY(-5px);
        }

        .related-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .related-info {
            padding: 10px;
        }

        .related-title {
            font-size: 14px;
            margin: 0 0 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .related-price {
            font-size: 16px;
            color: #e74c3c;
            font-weight: bold;
        }

        /* æ¶ˆæ¯è¡¨å• */
        .message-form {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .message-input {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
        }

        .send-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* å›¾ç‰‡å¯¼èˆªåŒºåŸŸæ ·å¼ */
        .image-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .image-thumbnails {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
            margin: 0 10px;
            flex: 1;
        }

        .thumbnail {
            width: 70px;
            height: 70px;
            border-radius: 4px;
            object-fit: cover;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .thumbnail:hover,
        .thumbnail.active {
            opacity: 1;
            border: 2px solid #3498db;
        }

        .nav-btn {
            background-color: #f1f1f1;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .nav-btn:hover {
            background-color: #ddd;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .product-content {
                flex-direction: column;
            }

            .action-buttons {
                flex-wrap: wrap;
            }

            .action-btn {
                flex: 1 0 40%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¯¼èˆªæ -->
        <nav class="navbar">
            <div class="nav-brand">æ ¡å›­äº’åŠ©å¹³å°</div>
            <div class="nav-links">
                <a href="index.html">é¦–é¡µ</a>
                <a href="market.html" class="active">äºŒæ‰‹å¸‚åœº</a>
                <a href="express.html">å¿«é€’ä»£é¢†</a>
                <a href="profile.html">ä¸ªäººä¸­å¿ƒ</a>
            </div>
        </nav>

        <!-- å•†å“è¯¦æƒ…å†…å®¹ -->
        <div class="detail-container">
            <div class="detail-header">
                <button class="back-btn" id="backBtn">è¿”å›åˆ—è¡¨</button>
            </div>

            <div class="product-content">
                <div class="product-images" id="mainImageContainer">
                    <img src="" alt="å•†å“ä¸»å›¾" class="main-image" id="mainImage" style="display:none;" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22120%22%20height%3D%22120%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2Fsvg%22%20viewBox%3D%220%200%20120%20120%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_1%20text%20%7B%20fill%3A%23999%3Bfont-weight%3Anormal%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_1%22%3E%3Crect%20width%3D%22120%22%20height%3D%22120%22%20fill%3D%22%23eee%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2240%22%20y%3D%2264.5%22%3Eæ— å›¾ç‰‡%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';">
                    <div class="image-navigation">
                        <button class="nav-btn" id="prevImage" disabled>&lt;</button>
                        <div class="image-thumbnails" id="thumbnailsContainer"></div>
                        <button class="nav-btn" id="nextImage" disabled>&gt;</button>
                    </div>
                </div>

                <div class="product-info">
                    <h1 class="product-title" id="productTitle">9æˆæ–°è®¡ç®—æœºç½‘ç»œæ•™æ</h1>
                    <div class="product-price">
                        Â¥ <span id="productPrice">25.00</span>
                        <span class="original-price">Â¥ 50.00</span>
                    </div>

                    <div class="product-meta">
                        <div class="meta-item">
                            <span class="meta-label">å•†å“åˆ†ç±»:</span>
                            <span id="productCategory">æ•™æä¹¦ç±</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">å•†å“æˆè‰²:</span>
                            <span id="productCondition">9æˆæ–°</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">å‘å¸ƒæ—¶é—´:</span>
                            <span id="publishTime">2023-06-01 10:30</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">æµè§ˆæ¬¡æ•°:</span>
                            <span id="viewCount">32</span>
                        </div>
                    </div>

                    <div class="product-description">
                        <h3>å•†å“æè¿°</h3>
                        <p id="productDescription">
                            å…¨æ–°æ­£ç‰ˆæ•™æï¼Œé€‚ç”¨äºè®¡ç®—æœºç½‘ç»œè¯¾ç¨‹ï¼Œä»…ç¿»é˜…è¿‡å‡ æ¬¡ï¼Œå‡ ä¹å…¨æ–°ã€‚å†…é¡µå¹²å‡€æ— ç¬”è®°ï¼Œæ— ç¼ºé¡µã€‚åŸä»·50å…ƒï¼Œç°åœ¨åŠä»·å‡ºå”®ã€‚æ ¡å†…å½“é¢äº¤æ˜“ï¼Œæ–¹ä¾¿å¿«æ·ã€‚æœ‰éœ€è¦çš„åŒå­¦è¯·è”ç³»æˆ‘ã€‚
                        </p>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn buy-btn" id="buyBtn">ç«‹å³è´­ä¹°</button>
                        <button class="action-btn contact-btn" id="contactBtn">è”ç³»å–å®¶</button>
                        <button class="action-btn favorite-btn" id="favoriteBtn">æ”¶è—</button>
                    </div>
                </div>
            </div>

            <div class="seller-info">
                <div class="seller-header">
                    <div class="seller-avatar">ğŸ‘¤</div>
                    <div>
                        <div class="seller-name" id="sellerName">å¼ åŒå­¦</div>
                        <div>å‘å¸ƒå•†å“<span id="sellerProductCount">5</span> ä»¶å•†å“</div>
                    </div>
                </div>
                <p>æ ¡å†…äº¤æ˜“ï¼Œå½“é¢éªŒè´§ä»˜æ¬¾ã€‚ä¸è®®ä»·ï¼Œè¯·çœ‹æ¸…å•†å“æè¿°å†è”ç³»ã€‚</p>
            </div>

            <div class="message-form">
                <h3>ç•™è¨€å’¨è¯¢</h3>
                <textarea class="message-input" placeholder="å¯¹è¿™ä¸ªå•†å“æœ‰ä»€ä¹ˆç–‘é—®ï¼Ÿåœ¨è¿™é‡Œç•™è¨€ç»™å–å®¶..."></textarea>
                <button class="send-btn" id="sendMessageBtn">å‘é€ç•™è¨€</button>
            </div>

            <div class="related-products">
                <h2 class="related-title">ç›¸å…³å•†å“æ¨è</h2>
                <div class="related-grid">
                    <div class="related-card" data-id="101">
                        <img src="../images/cc8fd9af524d9f81f2ee84d0fe9747cd.png" alt="ç›¸å…³å•†å“1" class="related-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2YxZjFmMSIvPjx0ZXh0IHg9IjE3MCIgeT0iMjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMzAiIGZpbGw9IiM5OTkiPuWbvueJh+acquWKoOi9vzwvdGV4dD48L3N2Zz4=';">
                        <div class="related-info">
                            <h3 class="related-title">æ•°æ®ç»“æ„æ•™æ</h3>
                            <div class="related-price">Â¥ 30.00</div>
                        </div>
                    </div>
                    <div class="related-card" data-id="102">
                        <img src="../images/cc8fd9af524d9f81f2ee84d0fe9747cd.png" alt="ç›¸å…³å•†å“2" class="related-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2YxZjFmMSIvPjx0ZXh0IHg9IjE3MCIgeT0iMjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMzAiIGZpbGw9IiM5OTkiPuWbvueJh+acquWKoOi9vzwvdGV4dD48L3N2Zz4=';">
                        <div class="related-info">
                            <h3 class="related-title">è®¡ç®—æœºç»„æˆåŸç†</h3>
                            <div class="related-price">Â¥ 28.00</div>
                        </div>
                    </div>
                    <div class="related-card" data-id="103">
                        <img src="../images/cc8fd9af524d9f81f2ee84d0fe9747cd.png" alt="ç›¸å…³å•†å“3" class="related-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2YxZjFmMSIvPjx0ZXh0IHg9IjE3MCIgeT0iMjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMzAiIGZpbGw9IiM5OTkiPuWbvueJh+acquWKoOi9vzwvdGV4dD48L3N2Zz4=';">
                        <div class="related-info">
                            <h3 class="related-title">æ“ä½œç³»ç»Ÿæ¦‚å¿µ</h3>
                            <div class="related-price">Â¥ 35.00</div>
                        </div>
                    </div>
                    <div class="related-card" data-id="104">
                        <img src="../images/cc8fd9af524d9f81f2ee84d0fe9747cd.png" alt="ç›¸å…³å•†å“4" class="related-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2YxZjFmMSIvPjx0ZXh0IHg9IjE3MCIgeT0iMjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMzAiIGZpbGw9IiM5OTkiPuWbvueJh+acquWKoOi9vzwvdGV4dD48L3N2Zz4=';">
                        <div class="related-info">
                            <h3 class="related-title">è½¯ä»¶å·¥ç¨‹å¯¼è®º</h3>
                            <div class="related-price">Â¥ 20.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message" class="message" style="display: none;"></div>
    </div>

    <script>
        // è®¾ç½®æœåŠ¡å™¨åœ°å€
        const serverAddress = 'http://localhost:8080';
        
        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // ====== æ–°å¢ï¼šæ ¹æ®typeå‚æ•°è‡ªåŠ¨è·³è½¬æ±‚è´­è¯¦æƒ…é¡µ ======
        (function() {
            const type = getUrlParameter('type');
            const id = getUrlParameter('id');
            if (type === 'wanted' && id) {
                window.location.replace(`wanted-detail.html?id=${id}`);
                return;
            }
        })();

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // è¿”å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('backBtn').addEventListener('click', function() {
            window.history.back();
        });

        // æ”¶è—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        let isFavorite = false;
        document.getElementById('favoriteBtn').addEventListener('click', function() {
            if (!checkAuth()) return;
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            this.disabled = true;
            
            // è§¦å‘æ”¶è—/å–æ¶ˆæ”¶è—æ“ä½œ
            toggleFavorite(this);
        });
        
        // æ§åˆ¶æ”¶è—/å–æ¶ˆæ”¶è—çŠ¶æ€
        async function toggleFavorite(button) {
            const productId = getUrlParameter('id') || '1';
            const token = localStorage.getItem('token');
            
            if (!token) {
                showMessage('è¯·å…ˆç™»å½•', 'warning');
                button.disabled = false;
                return;
            }
            
            try {
                let success = false;
                
                if (!isFavorite) {
                // æ·»åŠ æ”¶è—
                    console.log(`å°è¯•æ·»åŠ æ”¶è—ï¼Œå•†å“ID: ${productId}`);
                    success = await serverAddFavorite(productId, token);
                    if (success) {
                        isFavorite = true;
                        button.classList.add('active');
                        button.textContent = 'å·²æ”¶è—';
                        showMessage('æ”¶è—æˆåŠŸ', 'success');
                        console.log('æ”¶è—æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°');
            } else {
                        showMessage('æ”¶è—å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
                        console.error('æ”¶è—è¯·æ±‚å¤±è´¥');
                    }
                } else {
                    // ç§»é™¤æ”¶è—
                    console.log(`å°è¯•å–æ¶ˆæ”¶è—ï¼Œå•†å“ID: ${productId}`);
                    success = await serverRemoveFavorite(productId, token);
                    if (success) {
                        isFavorite = false;
                button.classList.remove('active');
                button.textContent = 'æ”¶è—';
                showMessage('å·²å–æ¶ˆæ”¶è—', 'info');
                        console.log('å–æ¶ˆæ”¶è—æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°');
                        } else {
                        showMessage('å–æ¶ˆæ”¶è—å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
                        console.error('å–æ¶ˆæ”¶è—è¯·æ±‚å¤±è´¥');
                    }
        }
        
                // é‡æ–°å¯ç”¨æŒ‰é’®
                button.disabled = false;
            } catch (error) {
                console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
                showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
                button.disabled = false;
            }
        }
        
        // æ·»åŠ åˆ°æ”¶è—
        async function addToFavorites(productId) {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æ”¶è—');
                return false;
            }
            
            return await serverAddFavorite(productId, token);
        }
        
        // ä»æ”¶è—ä¸­ç§»é™¤
        async function removeFromFavorites(productId) {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•å–æ¶ˆæ”¶è—');
                return false;
            }
            
            return await serverRemoveFavorite(productId, token);
        }
        
        // æœåŠ¡å™¨æ·»åŠ æ”¶è—
        async function serverAddFavorite(productId, token) {
            try {
                console.log('å°è¯•æ·»åŠ æ”¶è—ï¼Œå•†å“ID:', productId);
                
                // ç¡®ä¿ä½¿ç”¨æ•´æ•°ID
                const numericId = parseInt(productId, 10);
                if (isNaN(numericId)) {
                    console.error('æ— æ•ˆçš„å•†å“ID:', productId);
                    return false;
                }
                
                const response = await fetch(`${serverAddress}/api/profile/favorites`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        itemType: 'product',
                        itemId: numericId 
                    })
                });
                
                console.log('æ·»åŠ æ”¶è—å“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    console.error('æœåŠ¡å™¨æ‹’ç»æ”¶è—è¯·æ±‚:', response.status);
                    // å°è¯•è·å–é”™è¯¯ä¿¡æ¯
                    const text = await response.text();
                    console.error('é”™è¯¯è¯¦æƒ…:', text);
                }
                
                return response.ok;
            } catch (error) {
                console.error('æœåŠ¡å™¨æ·»åŠ æ”¶è—å‡ºé”™:', error);
                return false;
            }
        }
        
        // æœåŠ¡å™¨ç§»é™¤æ”¶è—
        async function serverRemoveFavorite(productId, token) {
            try {
                console.log('å°è¯•åˆ é™¤æ”¶è—ï¼Œå•†å“ID:', productId);
                
                // ç¡®ä¿productIdæ˜¯æ•´æ•°
                const numericId = parseInt(productId, 10);
                if (isNaN(numericId)) {
                    console.error('æ— æ•ˆçš„å•†å“ID:', productId);
                    return false;
                }
                
                const response = await fetch(`${serverAddress}/api/profile/favorites/product/${numericId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('åˆ é™¤æ”¶è—å“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    console.error('æœåŠ¡å™¨æ‹’ç»å–æ¶ˆæ”¶è—è¯·æ±‚:', response.status);
                    // å°è¯•è·å–é”™è¯¯ä¿¡æ¯
                    const text = await response.text();
                    console.error('é”™è¯¯è¯¦æƒ…:', text);
                }
                
                return response.ok;
            } catch (error) {
                console.error('æœåŠ¡å™¨ç§»é™¤æ”¶è—å‡ºé”™:', error);
                return false;
            }
        }

        // ç«‹å³è´­ä¹°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('buyBtn').addEventListener('click', function() {
            if (!checkAuth()) return;
            
            const productId = getUrlParameter('id') || '1';
            showMessage('æ­£åœ¨å‡†å¤‡è´­ä¹°...', 'info');
            
            // å®é™…é¡¹ç›®ä¸­ï¼Œåº”è¯¥è·³è½¬åˆ°ä¸‹å•é¡µé¢æˆ–å‘èµ·è´­ä¹°è¯·æ±‚
            setTimeout(() => {
                alert('æ­¤åŠŸèƒ½å°šæœªå®ç°ï¼Œå®é™…é¡¹ç›®ä¸­åº”è·³è½¬åˆ°ä¸‹å•é¡µé¢');
            }, 1000);
        });

        // è”ç³»å–å®¶/ç®¡ç†å•†å“æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('contactBtn').addEventListener('click', async function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'login.html';
                return;
            }

            try {
                // è·å–å•†å“ID
                const productId = getUrlParameter('id') || '1';
                
                // è·å–å•†å“è¯¦æƒ…ä»¥è·å–å–å®¶ID
                const productResponse = await fetch(`${serverAddress}/api/products/${productId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!productResponse.ok) {
                    throw new Error(`è·å–å•†å“è¯¦æƒ…å¤±è´¥: ${productResponse.status}`);
                }

                const product = await productResponse.json();
                const sellerId = product.userId;

                if (!sellerId) {
                    throw new Error('æ— æ³•è·å–å–å®¶ä¿¡æ¯');
                }

                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                const currentUser = JSON.parse(localStorage.getItem('user'));
                if (!currentUser || !currentUser.id) {
                    throw new Error('æ— æ³•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯');
                }

                // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„å•†å“
                const isOwnProduct = currentUser.id === sellerId;

                if (isOwnProduct) {
                    // å¦‚æœæ˜¯è‡ªå·±çš„å•†å“ï¼Œè·³è½¬åˆ°"æˆ‘çš„å•†å“"é¡µé¢
                    window.location.href = 'my-products.html';
                } else {
                    // å¦‚æœä¸æ˜¯è‡ªå·±çš„å•†å“ï¼Œåˆ›å»ºèŠå¤©
                    const response = await fetch(`${serverAddress}/messages/chats/create?otherUserId=${sellerId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'include',
                        mode: 'cors'
                    });

                    if (response.status === 401) {
                        alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                        window.location.href = 'login.html';
                        return;
                    }

                    if (response.status === 403) {
                        alert('æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ');
                        return;
                    }

                    if (response.status === 500) {
                        alert('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(`åˆ›å»ºèŠå¤©å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // è·³è½¬åˆ°æ¶ˆæ¯é¡µé¢
                    window.location.href = 'messages.html';
                    
                    // å­˜å‚¨èŠå¤©IDï¼Œä»¥ä¾¿åœ¨æ¶ˆæ¯é¡µé¢è‡ªåŠ¨é€‰ä¸­
                    localStorage.setItem('selectedChatId', data.id);
                }
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        });

        // å‘é€ç•™è¨€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('sendMessageBtn').addEventListener('click', function() {
            if (!checkAuth()) return;
            
            const messageInput = document.querySelector('.message-input');
            const message = messageInput.value.trim();
            
            if (!message) {
                showMessage('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'warning');
                return;
            }
            
            // å‘é€ç•™è¨€
            showMessage('ç•™è¨€å‘é€æˆåŠŸï¼Œç­‰å¾…å–å®¶å›å¤', 'success');
            messageInput.value = '';
            
            // å®é™…é¡¹ç›®ä¸­ï¼Œåº”è¯¥è°ƒç”¨APIå‘é€ç•™è¨€
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('è¯·å…ˆç™»å½•', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return false;
            }
            return true;
        }

        // ç›¸å…³å•†å“ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.related-card').forEach(card => {
            card.addEventListener('click', function() {
                const productId = this.getAttribute('data-id');
                window.location.href = `product-detail.html?id=${productId}`;
            });
        });

        // åŠ è½½å•†å“è¯¦æƒ…
        async function loadProductDetail() {
            const productId = getUrlParameter('id') || '1';
            console.log('åŠ è½½å•†å“ID:', productId);
            
            try {
                // å…ˆæ£€æŸ¥æ”¶è—çŠ¶æ€ï¼Œå†åŠ è½½å•†å“è¯¦æƒ…
                // è¿™æ ·å¯ä»¥é¿å…ä¸¤ä¸ªå¼‚æ­¥æ“ä½œäº’ç›¸å¹²æ‰°
                await checkFavoriteStatus(productId);
                
                // ä»APIè·å–å•†å“è¯¦æƒ…
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('æœªæ‰¾åˆ°è®¤è¯tokenï¼Œå¯èƒ½æ— æ³•è·å–å®Œæ•´æ•°æ®');
                }
                
                const response = await fetch(`${serverAddress}/api/products/${productId}`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Accept': 'application/json'
                    },
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    throw new Error(`è·å–å•†å“è¯¦æƒ…å¤±è´¥: ${response.status}`);
                }
                
                const product = await response.json();
                console.log('è·å–åˆ°å•†å“è¯¦æƒ…:', product);
                
                // å¤„ç†æ¥è‡ªåç«¯çš„å›¾ç‰‡URL
                if (product.images && Array.isArray(product.images)) {
                    // è¿‡æ»¤æ‰æ— æ•ˆçš„å›¾ç‰‡URLï¼ˆåŒ…æ‹¬placeholder.comé“¾æ¥ï¼‰
                    product.images = product.images.filter(img => {
                        if (!img) return false;
                        // è¿‡æ»¤æ‰placeholder.comé“¾æ¥
                        if (img.includes('placeholder.com')) return false;
                        return true;
                    });
                }
                
                // æ›´æ–°é¡µé¢å†…å®¹
                updateProductDetails(product);
                
                // è®°å½•æµè§ˆå†å²
                addToBrowseHistory(productId, product.title, product.price);
            } catch (error) {
                console.error('åŠ è½½å•†å“è¯¦æƒ…å‡ºé”™:', error);
                showMessage('åŠ è½½å•†å“å¤±è´¥: ' + error.message, 'error');
                
                // ä½¿ç”¨é™æ€æ•°æ®ä½œä¸ºå¤‡ä»½
                console.log('ä½¿ç”¨é™æ€æ•°æ®ä½œä¸ºå¤‡ä»½');
                // è®°å½•æµè§ˆå†å²
                addToBrowseHistory(productId);
            }
        }
        
        // æ›´æ–°äº§å“è¯¦æƒ…åˆ°é¡µé¢
        function updateProductDetails(product) {
            // æ›´æ–°æ ‡é¢˜å’Œä»·æ ¼
            document.getElementById('productTitle').textContent = product.title || 'æœªçŸ¥å•†å“';
            document.getElementById('productPrice').textContent = product.price ? product.price.toFixed(2) : '0.00';
            
            // æ›´æ–°åŸä»·ï¼ˆå¦‚æœæœ‰ï¼‰
            const originalPriceElement = document.querySelector('.original-price');
            if (product.originalPrice) {
                originalPriceElement.textContent = `Â¥ ${product.originalPrice.toFixed(2)}`;
                originalPriceElement.style.display = 'inline';
            } else {
                originalPriceElement.style.display = 'none';
            }
            
            // æ›´æ–°å•†å“åˆ†ç±»
            let categoryText = 'æœªåˆ†ç±»';
            if (product.category) {
                // åˆ†ç±»è‹±æ–‡åˆ°ä¸­æ–‡çš„æ˜ å°„
                const categoryMap = {
                    'books': 'æ•™æä¹¦ç±',
                    'electronics': 'ç”µå­äº§å“',
                    'daily': 'æ—¥ç”¨ç™¾è´§',
                    'clothing': 'æœè£…æœé¥°',
                    'sports': 'ä½“è‚²å™¨æ',
                    'others': 'å…¶ä»–'
                };
                categoryText = categoryMap[product.category] || product.category;
            }
            document.getElementById('productCategory').textContent = categoryText;
            
            // æ›´æ–°å•†å“æˆè‰²
            let condition = 'æœªçŸ¥';
            if (product.conditionLevel) {
                switch(product.conditionLevel) {
                    case 'new': condition = 'å…¨æ–°'; break;
                    case 'almost_new': condition = '9æˆæ–°'; break;
                    case 'slightly_used': condition = '7æˆæ–°'; break;
                    case 'used': condition = '5æˆæ–°åŠä»¥ä¸‹'; break;
                }
            }
            document.getElementById('productCondition').textContent = condition;
            
            // æ›´æ–°å‘å¸ƒæ—¶é—´
            if (product.publishTime) {
                const date = new Date(product.publishTime);
                document.getElementById('publishTime').textContent = date.toLocaleString();
            }
            
            // æ›´æ–°æµè§ˆé‡
            document.getElementById('viewCount').textContent = product.viewCount || '0';
            
            // æ›´æ–°æè¿°
            document.getElementById('productDescription').textContent = product.description || 'æš‚æ— æè¿°';
            
            // æ›´æ–°å–å®¶ä¿¡æ¯
            if (product.userName) {
                document.getElementById('sellerName').textContent = product.userName;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„å•†å“
            const currentUser = JSON.parse(localStorage.getItem('user'));
            const isOwnProduct = currentUser && currentUser.id === product.userId;
            
            // æ›´æ–°è”ç³»å–å®¶æŒ‰é’®
            const contactBtn = document.getElementById('contactBtn');
            if (isOwnProduct) {
                contactBtn.textContent = 'ç®¡ç†å•†å“';
                contactBtn.classList.remove('contact-btn');
                contactBtn.classList.add('manage-btn');
                contactBtn.style.backgroundColor = '#2ecc71'; // ç»¿è‰²
            } else {
                contactBtn.textContent = 'è”ç³»å–å®¶';
                contactBtn.classList.remove('manage-btn');
                contactBtn.classList.add('contact-btn');
                contactBtn.style.backgroundColor = '#3498db'; // è“è‰²
            }
            
            // æ›´æ–°äº§å“å›¾ç‰‡
            const mainImageContainer = document.getElementById('mainImageContainer');
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            
            // æ¸…ç©ºç°æœ‰çš„ç¼©ç•¥å›¾
            thumbnailsContainer.innerHTML = '';
            
            if (product.images && product.images.length > 0) {
                // å¤„ç†å›¾ç‰‡è·¯å¾„
                const processedImages = product.images.map(img => {
                    // æ£€æŸ¥å›¾ç‰‡è·¯å¾„æ˜¯å¦éœ€è¦æ·»åŠ æœåŠ¡å™¨å‰ç¼€
                    return img.startsWith('/uploads/') ? serverAddress + img : img;
                });
                
                // è®¾ç½®ä¸»å›¾
                const mainImage = document.getElementById('mainImage');
                mainImage.src = processedImages[0];
                mainImage.dataset.index = 0;
                mainImage.style.display = 'block';
                
                // è®¾ç½®å¯¼èˆªæŒ‰é’®çŠ¶æ€
                const prevBtn = document.getElementById('prevImage');
                const nextBtn = document.getElementById('nextImage');
                
                prevBtn.disabled = true;
                nextBtn.disabled = processedImages.length <= 1;
                
                // ç”Ÿæˆç¼©ç•¥å›¾
                processedImages.forEach((imgSrc, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.className = 'thumbnail' + (index === 0 ? ' active' : '');
                    thumbnail.src = imgSrc;
                    thumbnail.alt = `${product.title} - å›¾ç‰‡ ${index + 1}`;
                    thumbnail.dataset.index = index;
                    thumbnail.onerror = function() {
                        this.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22120%22%20height%3D%22120%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2Fsvg%22%20viewBox%3D%220%200%20120%20120%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_1%20text%20%7B%20fill%3A%23999%3Bfont-weight%3Anormal%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_1%22%3E%3Crect%20width%3D%22120%22%20height%3D%22120%22%20fill%3D%22%23eee%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2240%22%20y%3D%2264.5%22%3Eæ— å›¾ç‰‡%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                    };
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    thumbnail.addEventListener('click', function() {
                        switchMainImage(imgSrc, parseInt(this.dataset.index));
                    });
                    
                    thumbnailsContainer.appendChild(thumbnail);
                });
                
                // æ·»åŠ å¯¼èˆªæŒ‰é’®äº‹ä»¶
                prevBtn.onclick = function() {
                    const currentIndex = parseInt(mainImage.dataset.index);
                    if (currentIndex > 0) {
                        switchMainImage(processedImages[currentIndex - 1], currentIndex - 1);
                    }
                };
                
                nextBtn.onclick = function() {
                    const currentIndex = parseInt(mainImage.dataset.index);
                    if (currentIndex < processedImages.length - 1) {
                        switchMainImage(processedImages[currentIndex + 1], currentIndex + 1);
                    }
                };
            } else {
                // æ²¡æœ‰å›¾ç‰‡æ—¶æ˜¾ç¤ºå ä½å›¾
                const mainImage = document.getElementById('mainImage');
                mainImage.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22120%22%20height%3D%22120%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2Fsvg%22%20viewBox%3D%220%200%20120%20120%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_1%20text%20%7B%20fill%3A%23999%3Bfont-weight%3Anormal%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_1%22%3E%3Crect%20width%3D%22120%22%20height%3D%22120%22%20fill%3D%22%23eee%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2240%22%20y%3D%2264.5%22%3Eæ— å›¾ç‰‡%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                mainImage.style.display = 'block';
                
                // ç¦ç”¨å¯¼èˆªæŒ‰é’®
                document.getElementById('prevImage').disabled = true;
                document.getElementById('nextImage').disabled = true;
                
                // æ·»åŠ ä¸€ä¸ªå ä½ç¼©ç•¥å›¾
                const thumbnail = document.createElement('img');
                thumbnail.className = 'thumbnail active';
                thumbnail.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22120%22%20height%3D%22120%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2Fsvg%22%20viewBox%3D%220%200%20120%20120%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_1%20text%20%7B%20fill%3A%23999%3Bfont-weight%3Anormal%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_1%22%3E%3Crect%20width%3D%22120%22%20height%3D%22120%22%20fill%3D%22%23eee%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2240%22%20y%3D%2264.5%22%3Eæ— å›¾ç‰‡%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                thumbnail.alt = 'æ— å›¾ç‰‡';
                
                thumbnailsContainer.appendChild(thumbnail);
            }
        }

        // åˆ‡æ¢ä¸»å›¾ç‰‡
        function switchMainImage(imgSrc, index) {
            const mainImage = document.getElementById('mainImage');
            mainImage.src = imgSrc;
            mainImage.dataset.index = index;
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            const thumbnails = document.querySelectorAll('.thumbnail');
            const totalImages = thumbnails.length;
            
            document.getElementById('prevImage').disabled = index === 0;
            document.getElementById('nextImage').disabled = index === totalImages - 1;
            
            // æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€
            thumbnails.forEach(thumb => {
                if (parseInt(thumb.dataset.index) === index) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
            
            // ç¡®ä¿é€‰ä¸­çš„ç¼©ç•¥å›¾åœ¨å¯è§†åŒºåŸŸå†…
            const selectedThumb = document.querySelector('.thumbnail.active');
            if (selectedThumb) {
                selectedThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        // æ·»åŠ åˆ°æµè§ˆå†å²
        function addToBrowseHistory(productId, title, price) {
            // æœ¬åœ°å­˜å‚¨æµè§ˆå†å²
            let history = JSON.parse(localStorage.getItem('browseHistory') || '[]');
            
            // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
            const index = history.findIndex(item => item.id === productId);
            if (index !== -1) {
                history.splice(index, 1);
            }
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            history.unshift({
                id: productId,
                time: new Date().toISOString(),
                title: title,
                price: price
            });
            
            // åªä¿ç•™æœ€å¤š20æ¡å†å²è®°å½•
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            localStorage.setItem('browseHistory', JSON.stringify(history));
            
            // å‘åç«¯åŒæ­¥æµè§ˆè®°å½•
            syncBrowseHistoryToServer(productId);
        }

        // å‘åç«¯åŒæ­¥æµè§ˆè®°å½•
        function syncBrowseHistoryToServer(productId) {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œä¸åŒæ­¥æµè§ˆè®°å½•åˆ°æœåŠ¡å™¨');
                return;
            }
            
            console.log(`å¼€å§‹åŒæ­¥å•†å“ID=${productId}çš„æµè§ˆè®°å½•åˆ°æœåŠ¡å™¨...`);
            
            // ç¡®ä¿productIdæ˜¯æ•°å­—
            const numericProductId = parseInt(productId);
            if (isNaN(numericProductId)) {
                console.error('æ— æ•ˆçš„å•†å“ID:', productId);
                return;
            }
            
            fetch(`http://localhost:8080/api/profile/history/${numericProductId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (response.ok) {
                    console.log('æµè§ˆå†å²å·²åŒæ­¥åˆ°æœåŠ¡å™¨');
                    return;
                }
                
                console.error('åŒæ­¥æµè§ˆå†å²å¤±è´¥:', response.status);
                
                // å°è¯•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
                if (response.headers.get('content-type')?.includes('application/json')) {
                    return response.json().then(errorData => {
                        console.error('æœåŠ¡å™¨è¿”å›é”™è¯¯è¯¦æƒ…:', errorData);
                        throw new Error(errorData.error || 'æœªçŸ¥é”™è¯¯');
                    });
                } else {
                    return response.text().then(errorText => {
                        console.error('æœåŠ¡å™¨è¿”å›é”™è¯¯æ–‡æœ¬:', errorText);
                        throw new Error('æœåŠ¡å™¨è¿”å›éJSONé”™è¯¯ä¿¡æ¯');
                    });
                }
            })
            .catch(error => {
                console.error('åŒæ­¥æµè§ˆå†å²å‡ºé”™:', error);
            });
        }

        // æ–°å¢ï¼šä»æœåŠ¡å™¨è·å–æ”¶è—çŠ¶æ€
        async function checkFavoriteStatus(productId) {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            try {
                console.log('å¼€å§‹æ£€æŸ¥å•†å“æ”¶è—çŠ¶æ€...');
                
                // æ£€æŸ¥URLå‚æ•°æ˜¯å¦åŒ…å«isFavorite=true (ä»æˆ‘çš„æ”¶è—é¡µé¢è¿‡æ¥)
                const urlParams = new URLSearchParams(window.location.search);
                const isFavoriteParam = urlParams.get('isFavorite');
                
                if (isFavoriteParam === 'true') {
                    console.log('ä»æ”¶è—é¡µé¢è·³è½¬è€Œæ¥ï¼Œç›´æ¥æ ‡è®°ä¸ºå·²æ”¶è—çŠ¶æ€');
                    isFavorite = true;
                    const favoriteBtn = document.getElementById('favoriteBtn');
                    if (favoriteBtn) {
                        favoriteBtn.classList.add('active');
                        favoriteBtn.textContent = 'å·²æ”¶è—';
                    }
                    return;
                }
                
                const response = await fetch(`${serverAddress}/api/profile/favorites`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const favorites = await response.json();
                    console.log('è·å–åˆ°æ”¶è—åˆ—è¡¨:', favorites);
                    
                    // æ£€æŸ¥å½“å‰å•†å“æ˜¯å¦å·²è¢«æ”¶è—
                    // æ³¨æ„ï¼šéœ€è¦å°†IDè½¬ä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸ºAPIå¯èƒ½è¿”å›æ•°å­—æˆ–å­—ç¬¦ä¸²
                    const isProductFavorited = favorites.some(fav => 
                        (fav.itemType === 'product' || !fav.itemType) && 
                        fav.itemId.toString() === productId.toString()
                    );
                    
                    console.log('å•†å“æ”¶è—çŠ¶æ€:', isProductFavorited ? 'å·²æ”¶è—' : 'æœªæ”¶è—');
                    
                    // æ›´æ–°UIçŠ¶æ€
                    isFavorite = isProductFavorited;
                    const favoriteBtn = document.getElementById('favoriteBtn');
                    if (isFavorite) {
                        favoriteBtn.classList.add('active');
                        favoriteBtn.textContent = 'å·²æ”¶è—';
                    } else {
                        favoriteBtn.classList.remove('active');
                        favoriteBtn.textContent = 'æ”¶è—';
                    }
                } else {
                    console.error('è·å–æ”¶è—çŠ¶æ€å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å‡ºé”™:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadProductDetail();
        });
    </script>
</body>
</html> 
